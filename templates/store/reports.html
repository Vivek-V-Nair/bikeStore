{% extends 'base.html' %}

{% block title %}Reports & Analytics - Bike Store{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'store:dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item active">Reports</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>
                <i class="fas fa-chart-line me-2"></i>Reports & Analytics
            </h2>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary" onclick="exportReport('pdf')">
                    <i class="fas fa-file-pdf me-1"></i>Export PDF
                </button>
                <button type="button" class="btn btn-outline-success" onclick="exportReport('excel')">
                    <i class="fas fa-file-excel me-1"></i>Export Excel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Date Range Filter -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-calendar me-1"></i>Date Range Filter
                </h6>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" 
                               value="{{ request.GET.start_date|default:default_start_date }}">
                    </div>
                    <div class="col-md-3">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" 
                               value="{{ request.GET.end_date|default:default_end_date }}">
                    </div>
                    <div class="col-md-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('today')">Today</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('week')">This Week</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('month')">This Month</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setDateRange('year')">This Year</button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>Generate Report
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-uppercase mb-1">Total Sales</h6>
                        <h4 class="mb-0">{{ total_sales }}</h4>
                        <small class="opacity-75">+{{ sales_growth|floatformat:1 }}% from last period</small>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-shopping-cart fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-uppercase mb-1">Revenue</h6>
                        <h4 class="mb-0">₹{{ total_revenue|floatformat:0 }}</h4>
                        <small class="opacity-75">+{{ revenue_growth|floatformat:1 }}% from last period</small>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-rupee-sign fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-uppercase mb-1">Avg. Sale</h6>
                        <h4 class="mb-0">₹{{ avg_sale|floatformat:0 }}</h4>
                        <small class="opacity-75">{{ avg_sale_change|floatformat:1 }}% from avg.</small>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="text-uppercase mb-1">Customers</h6>
                        <h4 class="mb-0">{{ active_customers }}</h4>
                        <small class="opacity-75">{{ new_customers }} new customers</small>
                    </div>
                    <div class="ms-3">
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Sales Trend Chart -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-line me-1"></i>Sales Trend
                </h6>
            </div>
            <div class="card-body">
                <canvas id="salesTrendChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Top Bikes Chart -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-bicycle me-1"></i>Top Selling Bikes
                </h6>
            </div>
            <div class="card-body">
                <canvas id="topBikesChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Additional Charts Row -->
<div class="row mb-4">
    <!-- Bike Types Distribution -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-pie me-1"></i>Sales by Bike Type
                </h6>
            </div>
            <div class="card-body">
                <canvas id="bikeTypesChart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Monthly Revenue -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar me-1"></i>Monthly Revenue Comparison
                </h6>
            </div>
            <div class="card-body">
                <canvas id="monthlyRevenueChart" height="250"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Data Tables Row -->
<div class="row mb-4">
    <!-- Top Customers -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-star me-1"></i>Top Customers
                </h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Purchases</th>
                                <th>Total Spent</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for customer in top_customers %}
                                <tr>
                                    <td>
                                        <a href="{% url 'store:customer_detail' customer.pk %}" 
                                           class="text-decoration-none">
                                            {{ customer.name }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ customer.purchase_count }}</span>
                                    </td>
                                    <td>₹{{ customer.total_spent|floatformat:0 }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Low Stock Alert -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-1"></i>Low Stock Alert
                </h6>
            </div>
            <div class="card-body">
                {% if low_stock_bikes %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Bike</th>
                                    <th>Current Stock</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bike in low_stock_bikes %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'store:bike_detail' bike.pk %}" 
                                               class="text-decoration-none">
                                                {{ bike.brand }} {{ bike.model }}
                                            </a>
                                        </td>
                                        <td>{{ bike.stock_quantity }}</td>
                                        <td>
                                            {% if bike.stock_quantity == 0 %}
                                                <span class="badge bg-danger">Out of Stock</span>
                                            {% else %}
                                                <span class="badge bg-warning">Low Stock</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <p>All bikes are well stocked!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-clock me-1"></i>Recent Sales Activity
                </h6>
            </div>
            <div class="card-body">
                {% if recent_sales %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Bike</th>
                                    <th>Quantity</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for sale in recent_sales %}
                                    <tr>
                                        <td>{{ sale.sale_date|date:"M d, Y H:i" }}</td>
                                        <td>
                                            <a href="{% url 'store:customer_detail' sale.customer.pk %}" 
                                               class="text-decoration-none">
                                                {{ sale.customer.name }}
                                            </a>
                                        </td>
                                        <td>
                                            <a href="{% url 'store:bike_detail' sale.bike.pk %}" 
                                               class="text-decoration-none">
                                                {{ sale.bike.brand }} {{ sale.bike.model }}
                                            </a>
                                        </td>
                                        <td>{{ sale.quantity }}</td>
                                        <td>₹{{ sale.total_amount|floatformat:0 }}</td>
                                        <td>
                                            <a href="{% url 'store:sale_detail' sale.pk %}" 
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-3">
                        <p>No recent sales activity to display.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Sales Trend Chart
    const salesTrendCtx = document.getElementById('salesTrendChart').getContext('2d');
    new Chart(salesTrendCtx, {
        type: 'line',
        data: {
            labels: {{ sales_trend_labels|safe }},
            datasets: [{
                label: 'Sales',
                data: {{ sales_trend_data|safe }},
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Top Bikes Chart
    const topBikesCtx = document.getElementById('topBikesChart').getContext('2d');
    new Chart(topBikesCtx, {
        type: 'doughnut',
        data: {
            labels: {{ top_bikes_labels|safe }},
            datasets: [{
                data: {{ top_bikes_data|safe }},
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Bike Types Chart
    const bikeTypesCtx = document.getElementById('bikeTypesChart').getContext('2d');
    new Chart(bikeTypesCtx, {
        type: 'pie',
        data: {
            labels: {{ bike_types_labels|safe }},
            datasets: [{
                data: {{ bike_types_data|safe }},
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });

    // Monthly Revenue Chart
    const monthlyRevenueCtx = document.getElementById('monthlyRevenueChart').getContext('2d');
    new Chart(monthlyRevenueCtx, {
        type: 'bar',
        data: {
            labels: {{ monthly_labels|safe }},
            datasets: [{
                label: 'Revenue (₹)',
                data: {{ monthly_revenue_data|safe }},
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₹' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
});

function setDateRange(period) {
    const today = new Date();
    let startDate, endDate = today;
    
    switch(period) {
        case 'today':
            startDate = today;
            break;
        case 'week':
            startDate = new Date(today);
            startDate.setDate(today.getDate() - 7);
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            break;
        case 'year':
            startDate = new Date(today.getFullYear(), 0, 1);
            break;
    }
    
    $('#start_date').val(startDate.toISOString().split('T')[0]);
    $('#end_date').val(endDate.toISOString().split('T')[0]);
}

function exportReport(format) {
    const startDate = $('#start_date').val();
    const endDate = $('#end_date').val();
    const url = `{% url 'store:reports' %}?export=${format}&start_date=${startDate}&end_date=${endDate}`;
    window.open(url, '_blank');
}
</script>
{% endblock %}